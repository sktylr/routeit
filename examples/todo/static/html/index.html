<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My TODO Lists</title>
  <link rel="stylesheet" href="css/base.css"/>
  <link rel="stylesheet" href="css/index.css"/>
</head>
<body>
  <main class="container">
    <div class="top-bar">
      <button id="createListBtn" class="create-btn">Create List</button>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <h1 class="page-title">My TODO Lists</h1>

    <div id="listsContainer" class="lists-grid"></div>

    <div class="pagination">
      <button id="prevPage" disabled>Previous</button>
      <span id="pageInfo"></span>
      <button id="nextPage">Next</button>
    </div>
  </main>

  <div id="createListModal" class="modal hidden">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2>Create a New List</h2>
      <form id="createListForm">
        <label for="listName">Name *</label>
        <input type="text" id="listName" name="listName" required />

        <label for="listDescription">Description</label>
        <textarea id="listDescription" name="listDescription"></textarea>

        <p id="formError" class="form-error"></p>

        <div class="modal-actions">
          <button type="submit" class="submit-btn">Create</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { getLists, createList } from "./api.js";
    import { logout } from "./auth.js";

    const listsContainer = document.getElementById("listsContainer");
    const prevBtn = document.getElementById("prevPage");
    const nextBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");
    const logoutBtn = document.getElementById("logoutBtn");
    const createBtn = document.getElementById("createListBtn");

    const modal = document.getElementById("createListModal");
    const closeModal = document.getElementById("closeModal");
    const form = document.getElementById("createListForm");
    const formError = document.getElementById("formError");
    const listNameInput = document.getElementById("listName");
    const listDescInput = document.getElementById("listDescription");

    let currentPage = 1;
    const pageSize = 6;

    async function loadLists(page = 1) {
      const { status, data } = await getLists(page, pageSize);

      if (status === 401) {
        logout();
        return;
      }

      if (status !== 200 || !data) {
        listsContainer.innerHTML = "<p class='error'>Failed to load lists.</p>";
        return;
      }

      const { lists, total, page: current, page_size } = data;

      listsContainer.innerHTML = "";
      lists.forEach(list => {
        const card = document.createElement("div");
        card.className = "list-card";

        let itemsMarkup = "";
        if (list.items && list.items.length > 0) {
          let itemsToShow = [...list.items];
          if (itemsToShow.length === 10) {
            itemsToShow[itemsToShow.length - 1] = { name: "...", status: "ELLIPSIS" };
          }

          itemsMarkup = itemsToShow.map(item => {
            if (item.status === "ELLIPSIS") {
              return `<li class="ellipsis">...</li>`;
            }
            return `
              <li class="${item.status === 'COMPLETED' ? 'done' : ''}">
                ${item.name}
              </li>
            `;
          }).join("");
        } else {
          itemsMarkup = `<li class="empty">No items yet</li>`;
        }

        const completionPercent = list.total_items > 0
          ? Math.round((list.completed_items / list.total_items) * 100)
          : 0;

        card.innerHTML = `
          <h2>${list.name}</h2>
          <p class="description">${list.description}</p>
          <ul class="items">
            ${itemsMarkup}
          </ul>
          <div class="progress">
            <div class="progress-bar" style="width:${completionPercent}%"></div>
          </div>
          <p class="progress-label">${completionPercent}% completed</p>
        `;

        listsContainer.appendChild(card);
      });

      currentPage = current;
      pageInfo.textContent = `Page ${current} of ${Math.ceil(total / page_size)}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage >= Math.ceil(total / page_size);
    }

    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
      }
      loadLists(currentPage)
    });

    nextBtn.addEventListener("click", () => {
      currentPage++;
      loadLists(currentPage)
    });

    logoutBtn.addEventListener("click", logout);

    createBtn.addEventListener("click", () => {
      modal.classList.remove("hidden");
      form.reset();
      formError.textContent = "";
    });

    closeModal.addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      formError.textContent = "";

      const name = listNameInput.value.trim();
      const description = listDescInput.value.trim();

      if (!name) {
        formError.textContent = "Name is required.";
        return;
      }

      const { status } = await createList(name, description);

      if (status >= 200 && status < 300) {
        modal.classList.add("hidden");
        await loadLists(currentPage);
      } else {
        formError.textContent = "Failed to create list. Please try again.";
      }
    });

    loadLists();
  </script>
</body>
</html>
