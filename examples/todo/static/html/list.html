<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TODO List</title>
  <link rel="stylesheet" href="/css/base.css"/>
  <link rel="stylesheet" href="/css/list.css"/>
</head>
<body>
  <main class="container">
    <div class="top-bar">
      <button id="backBtn" class="back-btn">‚Üê Back</button>
      <button id="addItemBtn" class="add-btn" aria-label="Add new item">+</button>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <div id="listDetails" class="list-details"></div>

    <div id="itemsContainer" class="items-grid"></div>

    <div class="pagination">
      <button id="prevPage" disabled>Previous</button>
      <span id="pageInfo"></span>
      <button id="nextPage">Next</button>
    </div>

    <div id="addItemModal" class="modal hidden">
      <div class="modal-content">
        <button class="close-btn" id="closeModal">&times;</button>
        <h2>Add New Item</h2>
        <form id="addItemForm">
          <label for="itemName">Name <span class="required">*</span></label>
          <input type="text" id="itemName" name="itemName" required />
          <p id="modalError" class="error hidden"></p>
          <button type="submit">Add</button>
        </form>
      </div>
    </div>

    <div id="editListModal" class="modal hidden">
      <div class="modal-content">
        <button class="close-btn" id="closeEditListModal">&times;</button>
        <h2>Edit List</h2>
        <form id="editListForm">
          <label for="editListName">Name <span class="required">*</span></label>
          <input type="text" id="editListName" name="editListName" required />

          <label for="editListDescription">Description</label>
          <input type="text" id="editListDescription" name="editListDescription" />

          <p id="editListError" class="error hidden"></p>
          <button type="submit">Save</button>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    import {
      getList,
      getItemsForList,
      markItemCompleted,
      markItemPending,
      createItemForList,
      deleteItem,
      updateItem,
      updateList
    } from "/api.js";
    import { logout } from "/auth.js";

    const pathParts = window.location.pathname.split("/");
    const id = pathParts.length >= 3 ? pathParts[2] : null;

    if (!id) {
      window.location.href = "/";
    }

    const listDetails = document.getElementById("listDetails");
    const itemsContainer = document.getElementById("itemsContainer");
    const prevBtn = document.getElementById("prevPage");
    const nextBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");
    const logoutBtn = document.getElementById("logoutBtn");
    const backBtn = document.getElementById("backBtn");
    const addItemBtn = document.getElementById("addItemBtn");
    const addItemModal = document.getElementById("addItemModal");
    const closeModal = document.getElementById("closeModal");
    const addItemForm = document.getElementById("addItemForm");
    const modalError = document.getElementById("modalError");
    const editListModal = document.getElementById("editListModal");
    const closeEditListModal = document.getElementById("closeEditListModal");
    const editListForm = document.getElementById("editListForm");
    const editListError = document.getElementById("editListError");

    let currentPage = 1;
    const pageSize = 10;

    async function loadData(page = 1) {
      const [listRes, itemsRes] = await Promise.all([
        getList(id),
        getItemsForList(id, page, pageSize)
      ]);

      if (listRes.status === 401 || itemsRes.status === 401) {
        logout();
        return;
      }

      if (listRes.status !== 200 || !listRes.data) {
        listDetails.innerHTML = "<p class='error'>Failed to load list.</p>";
        return;
      }

      const list = listRes.data;
      listDetails.innerHTML = `
        <h1>
          ${list.name}
          <button class="edit-list-btn" id="editListBtn" aria-label="Edit list">‚úèÔ∏è</button>
        </h1>
        <p class="description">${list.description || ""}</p>
        <p class="meta">Created: ${new Date(list.created).toLocaleString()}</p>
      `;

      const editListBtn = document.getElementById("editListBtn");
      editListBtn.addEventListener("click", () => {
        editListForm.editListName.value = list.name;
        editListForm.editListDescription.value = list.description || "";
        editListError.classList.add("hidden");
        editListModal.classList.remove("hidden");
      });

      if (itemsRes.status !== 200 || !itemsRes.data) {
        itemsContainer.innerHTML = "<p class='error'>Failed to load items.</p>";
        return;
      }

      const { items, total, page: current, page_size } = itemsRes.data;
      itemsContainer.innerHTML = "";

      if (!items || items.length === 0) {
        itemsContainer.innerHTML = "<p class='empty'>No items in this list yet.</p>";
      } else {
        items.forEach(item => {
          const completed = item.status === 'COMPLETED';
          const el = document.createElement("div");
          el.className = `item-card ${completed ? "done" : ""}`;
          el.innerHTML = `
            <h3>${item.name}</h3>
            <p class="meta">Created: ${new Date(item.created).toLocaleString()}</p>
            <div class="actions">
              <button
                class="action-btn status-btn"
                aria-label="${completed ? 'Mark as pending' :'Mark as completed'}"
                title="${completed ? 'Mark as pending' :'Mark as completed'}"
              >
                ${completed ? "‚Ü©Ô∏è" : "‚úÖ"}
              </button>
              <button class="action-btn edit" aria-label="Edit item">‚úèÔ∏è</button>
              <button class="action-btn delete" aria-label="Delete item">üóëÔ∏è</button>
            </div>
          `;

          const statusBtn = el.querySelector(".status-btn");
          statusBtn.addEventListener("click", async () => {
            statusBtn.disabled = true;
            let res;
            if (completed) {
              res = await markItemPending(id, item.id);
            } else {
              res = await markItemCompleted(id, item.id);
            }
            statusBtn.disabled = false;

            if (res.status >= 200 && res.status < 300) {
              loadData(currentPage);
            } else {
              alert("Failed to update item. Please try again.");
            }
          });

          const deleteBtn = el.querySelector(".delete");
          deleteBtn.addEventListener("click", async () => {
            if (!confirm("Are you sure you want to delete this item?")) {
              return;
            }
            const res = await deleteItem(id, item.id);
            if (res.status === 204) {
              el.remove();
              loadData(currentPage);
            }
          });

          const editBtn = el.querySelector(".edit");
          const titleEl = el.querySelector("h3");
          editBtn.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "text";
            input.value = item.name;
            input.className = "edit-input";

            titleEl.replaceWith(input);
            input.focus();

            const save = async () => {
              const newName = input.value.trim();
              if (newName && newName !== item.name) {
                const res = await updateItem(id, item.id, newName);
                if (res.status >= 200 && res.status < 300) {
                  loadData(currentPage);
                  return;
                }
              }
              loadData(currentPage);
            };

            input.addEventListener("blur", save);
            input.addEventListener("keydown", e => {
              if (e.key === "Enter") {
                e.preventDefault();
                save();
              } else if (e.key === "Escape") {
                loadData(currentPage);
              }
            });
          });

          itemsContainer.appendChild(el);
        });
      }

      currentPage = current;
      pageInfo.textContent = `Page ${current} of ${Math.ceil(total / page_size)}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage >= Math.ceil(total / page_size);
    }

    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        loadData(currentPage);
      }
    });

    nextBtn.addEventListener("click", () => {
      currentPage++;
      loadData(currentPage);
    });

    logoutBtn.addEventListener("click", logout);
    backBtn.addEventListener("click", () => window.location.href = "/");

    addItemBtn.addEventListener("click", () => {
      addItemModal.classList.remove("hidden");
      modalError.classList.add("hidden");
      addItemForm.reset();
    });

    closeModal.addEventListener("click", () => {
      addItemModal.classList.add("hidden");
    });

    addItemForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = addItemForm.itemName.value.trim();
      if (!name) return;

      const res = await createItemForList(id, name);
      if (res.status >= 200 && res.status < 300) {
        addItemModal.classList.add("hidden");
        loadData(currentPage);
      } else {
        modalError.textContent = "Failed to add item. Please try again.";
        modalError.classList.remove("hidden");
      }
    });

    closeEditListModal.addEventListener("click", () => {
      editListModal.classList.add("hidden");
    });

    editListForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = editListForm.editListName.value.trim();
      const description = editListForm.editListDescription.value.trim();

      if (!name) {
        editListError.textContent = "Name is required.";
        editListError.classList.remove("hidden");
        return;
      }

      const res = await updateList(id, name, description);
      if (res.status >= 200 && res.status < 300) {
        editListModal.classList.add("hidden");
        loadData(currentPage);
      } else {
        editListError.textContent = "Failed to update list. Please try again.";
        editListError.classList.remove("hidden");
      }
    });

    loadData();
  </script>
</body>
</html>
